{% extends 'base.html' %}

{% block content %}
<div class="container py-4 fade-in-up">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold m-0"><i class="fa-solid fa-calendar-check text-primary me-2"></i>Gestão de Eventos</h3>
            <p class="text-muted mb-0">Controle administrativo de eventos, inscrições e validação de presença.</p>
        </div>
        <a href="/criar_evento" class="btn btn-primary shadow-sm">
            <i class="fa-solid fa-plus me-2"></i> Novo Evento
        </a>
    </div>

    <!-- FILTERS -->
    <div class="glass-panel p-4 mb-4 bg-white border-top border-2 border-primary shadow-sm">
        <h6 class="fw-bold mb-3 text-uppercase small text-muted"><i class="fa-solid fa-filter me-2"></i>Filtrar Eventos</h6>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="small fw-bold">Título / Nome</label>
                <input type="text" id="filtNome" class="form-control form-control-sm" placeholder="Ex: Simpósio...">
            </div>
            <div class="col-md-3">
                <label class="small fw-bold">Curso / Depto</label>
                <input type="text" id="filtCurso" class="form-control form-control-sm" placeholder="Ex: TI...">
            </div>
            <div class="col-md-2">
                <label class="small fw-bold">Data Início</label>
                <input type="date" id="filtData" class="form-control form-control-sm">
            </div>
            <div class="col-md-2">
                <label class="small fw-bold">Status</label>
                <select id="filtStatus" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option value="ABERTO">Aberto</option>
                    <option value="ENCERRADO">Encerrado</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button onclick="carregarEventos(1)" class="btn btn-primary btn-sm w-100 fw-bold">
                    <i class="fa-solid fa-magnifying-glass me-1"></i> Pesquisar
                </button>
            </div>
        </div>
    </div>

    <!-- EVENTS TABLE -->
    <div class="glass-panel p-0 overflow-hidden mb-4">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Evento</th>
                        <th>Tipo / Status</th>
                        <th>Data Início</th>
                        <th>Participação</th>
                        <th>Responsável</th>
                        <th class="text-end pe-4">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaEventos">
                    <!-- Preenchido via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <nav><ul class="pagination justify-content-center" id="paginacaoEventos"></ul></nav>
</div>

<!-- Modal Broadcast Notification -->
<div class="modal fade" id="modalNotificacao" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-paper-plane me-2"></i>Notificar Participantes</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted small mb-4">Envie uma mensagem para todos os participantes inscritos no evento <strong id="notifEventName"></strong>.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold small">Assunto</label>
                    <input type="text" id="notifAssunto" class="form-control" placeholder="Ex: Alteração de Sala ou Aviso Importante">
                </div>
                <div class="mb-0">
                    <label class="form-label fw-bold small">Mensagem</label>
                    <textarea id="notifMensagem" class="form-control" rows="5" placeholder="Digite sua mensagem aqui..."></textarea>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-info text-white px-4 fw-bold" onclick="enviarNotificacao()">
                    <i class="fa-solid fa-envelope-circle-check me-2"></i> Enviar Agora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Manage Participants -->
<div class="modal fade" id="modalParticipantes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 bg-dark text-white">
                <div class="d-flex align-items-center gap-3">
                    <h5 class="modal-title fw-bold m-0"><i class="fa-solid fa-users me-2"></i>Participantes</h5>
                    <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="mostrarAreaAdicao()">
                        <i class="fa-solid fa-user-plus me-1"></i> Adicionar
                    </button>
                </div>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Add Participant Area (Hidden by default) -->
                <div id="areaAdicao" class="p-4 bg-indigo-50 border-bottom d-none animate__animated animate__fadeIn">
                    <h6 class="fw-bold mb-3 text-primary">Nova Inscrição Manual</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-7">
                            <label class="small fw-bold text-muted mb-1">Buscar Participante (Nome, RA ou CPF)</label>
                            <input type="text" id="addPartSearch" class="form-control" placeholder="Digite para buscar..." oninput="buscarParticipantesLive(this.value)">
                            <div id="resultadosBusca" class="list-group shadow-sm mt-1 position-absolute w-100 d-none" style="z-index: 1050; max-width: 400px;">
                                <!-- Resultados JS -->
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="small fw-bold text-muted mb-1">Atividade</label>
                            <select id="addPartAtividade" class="form-select">
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                    </div>
                    
                    <div id="participanteSelecionado" class="alert alert-primary d-none d-flex justify-content-between align-items-center rounded-4 py-2">
                        <div>
                            <i class="fa-solid fa-user-check me-2"></i>
                            <span class="fw-bold" id="selNome"></span> 
                            <small class="ms-2 text-primary-emphasis" id="selCpf"></small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="executarInscricaoManual()">Inscrever Agora</button>
                    </div>

                    <div class="mt-2 small text-muted"><i class="fa-solid fa-circle-info me-1"></i> O participante deve estar previamente cadastrado no sistema.</div>
                </div>

                <div class="p-4 bg-light border-bottom">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="filtPartNome" class="form-control" placeholder="Buscar por nome..." oninput="carregarParticipantes(1)">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="filtPartCpf" class="form-control" placeholder="CPF..." oninput="carregarParticipantes(1)">
                        </div>
                        <div class="col-md-3">
                            <select id="filtPartPresenca" class="form-select" onchange="carregarParticipantes(1)">
                                <option value="">Todos (Presença)</option>
                                <option value="true">Presentes</option>
                                <option value="false">Ausentes</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-dark w-100" onclick="carregarParticipantes(1)">Atualizar</button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive" style="min-height: 400px;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Nome</th>
                                <th>CPF</th>
                                <th>Atividade</th>
                                <th>Presença</th>
                                <th>Distância</th>
                                <th class="text-end pe-4">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaParticipantes"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <nav class="me-auto"><ul class="pagination pagination-sm m-0" id="paginacaoParticipantes"></ul></nav>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let EVENTO_SELECIONADO_ID = null;

    document.addEventListener('DOMContentLoaded', () => carregarEventos(1));

    async function carregarEventos(page) {
        const filters = {
            nome: document.getElementById('filtNome').value,
            curso: document.getElementById('filtCurso').value,
            data: document.getElementById('filtData').value,
            status: document.getElementById('filtStatus').value,
            page: page
        };
        const params = new URLSearchParams(filters);
        const res = await fetch(`/api/eventos_admin?${params.toString()}`);
        const data = await res.json();
        
        const tbody = document.getElementById('tabelaEventos');
        tbody.innerHTML = '';
        
        data.items.forEach(ev => {
            const statusBadge = ev.status === 'ABERTO' ? '<span class="badge bg-success-subtle text-success border border-success-subtle">ABERTO</span>' : '<span class="badge bg-secondary-subtle text-secondary">ENCERRADO</span>';
            const tipoBadge = `<span class="badge bg-indigo-50 text-indigo-600 border border-indigo-100">${ev.tipo}</span>`;
            const cursoBadge = ev.curso ? `<span class="badge text-color-primary border ms-1"><i class="fa-solid fa-graduation-cap me-1"></i>${ev.curso}</span>` : '';
            
            const partInfo = `
                <div class="d-flex align-items-center gap-2">
                    <div class="text-center">
                        <div class="fw-bold text-dark small">${ev.total_inscritos}</div>
                        <div class="text-muted x-small">Inscritos</div>
                    </div>
                    <div class="vr" style="height: 20px;"></div>
                    <div class="text-center">
                        <div class="fw-bold text-success small">${ev.total_presentes}</div>
                        <div class="text-muted x-small">Presenças</div>
                    </div>
                </div>`;

            tbody.innerHTML += `
                <tr class="animate__animated animate__fadeIn">
                    <td class="ps-4">
                        <div class="fw-bold text-dark fs-6">${ev.nome}</div>
                        <div class="d-flex align-items-center mt-1">
                            <span class="text-muted x-small me-2">${ev.atividades.length} atividades</span>
                            ${cursoBadge}
                        </div>
                    </td>
                    <td>${tipoBadge} ${statusBadge}</td>
                    <td><small class="fw-bold text-slate-600">${ev.data_inicio.split('-').reverse().join('/')}</small></td>
                    <td>${partInfo}</td>
                    <td><span class="badge bg-light text-dark border font-monospace">${ev.owner}</span></td>
                    <td class="text-end pe-4">
                        <div class="btn-group shadow-sm">
                            <a href="/editar_evento/${ev.id}" class="btn btn-sm btn-light border" title="Editar Evento">
                                <i class="fa-solid fa-pen-to-square text-indigo-600"></i>
                            </a>
                            <button class="btn btn-sm btn-light border" onclick="abrirParticipantes(${ev.id})" title="Participantes">
                                <i class="fa-solid fa-users-viewfinder text-primary"></i>
                            </button>
                            <button class="btn btn-sm btn-light border" onclick="abrirModalNotificacao(${ev.id}, '${ev.nome}')" title="Notificar Participantes">
                                <i class="fa-solid fa-envelope text-info"></i>
                            </button>
                            <a href="/designer_certificado/${ev.id}" class="btn btn-sm btn-light border" title="Certificado">
                                <i class="fa-solid fa-certificate text-warning"></i>
                            </a>
                            <button class="btn btn-sm btn-light border text-danger" onclick="confirmarExcluirEvento(${ev.id})">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        renderPaginacao(data.current_page, data.pages, 'paginacaoEventos', carregarEventos);
    }

    async function abrirParticipantes(eventId) {
        EVENTO_SELECIONADO_ID = eventId;
        document.getElementById('areaAdicao').classList.add('d-none'); // Reset view
        
        // Load activities for this event to populate the add select
        const res = await fetch(`/api/eventos`);
        const data = await res.json();
        // Since /api/eventos is now paginated, we access items
        const ev = data.items.find(e => e.id == eventId);
        
        const selAtv = document.getElementById('addPartAtividade');
        selAtv.innerHTML = '<option value="">-- Selecione a Atividade --</option>';
        if (ev && ev.atividades) {
            ev.atividades.forEach(a => {
                selAtv.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
            });
        }

        new bootstrap.Modal(document.getElementById('modalParticipantes')).show();
        carregarParticipantes(1);
    }

    function abrirModalNotificacao(id, nome) {
        EVENTO_SELECIONADO_ID = id;
        document.getElementById('notifEventName').innerText = nome;
        document.getElementById('notifAssunto').value = '';
        document.getElementById('notifMensagem').value = '';
        new bootstrap.Modal(document.getElementById('modalNotificacao')).show();
    }

    async function enviarNotificacao() {
        const subject = document.getElementById('notifAssunto').value;
        const message = document.getElementById('notifMensagem').value;
        
        if(!subject || !message) {
            Swal.fire('Erro', 'Assunto e mensagem são obrigatórios.', 'warning');
            return;
        }

        const res = await fetch(`/api/notificar_participantes/${EVENTO_SELECIONADO_ID}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ assunto: subject, mensagem: message })
        });

        if(res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalNotificacao')).hide();
            Toast.fire({ icon: 'success', title: 'Notificações enviadas para a fila!' });
        } else {
            const data = await res.json();
            Swal.fire('Erro', data.erro, 'error');
        }
    }

    function mostrarAreaAdicao() {
        const area = document.getElementById('areaAdicao');
        area.classList.toggle('d-none');
        document.getElementById('addPartSearch').value = '';
        document.getElementById('resultadosBusca').classList.add('d-none');
        document.getElementById('participanteSelecionado').classList.add('d-none');
    }

    let timeoutBusca = null;
    async function buscarParticipantesLive(q) {
        clearTimeout(timeoutBusca);
        const div = document.getElementById('resultadosBusca');
        if (q.length < 2) { div.classList.add('d-none'); return; }

        timeoutBusca = setTimeout(async () => {
            const res = await fetch(`/api/buscar_participante?q=${encodeURIComponent(q)}`);
            const users = await res.json();
            
            div.innerHTML = '';
            if (users.length === 0) {
                div.innerHTML = '<div class="list-group-item small text-muted">Nenhum resultado encontrado.</div>';
            } else {
                users.forEach(u => {
                    const btn = document.createElement('button');
                    btn.className = 'list-group-item list-group-item-action text-start';
                    btn.type = 'button';
                    btn.innerHTML = `
                        <div class="fw-bold small">${u.nome}</div>
                        <div class="x-small text-muted">RA: ${u.ra || 'N/A'} | CPF: ${u.cpf}</div>
                    `;
                    btn.onclick = () => selecionarUsuarioBusca(u);
                    div.appendChild(btn);
                });
            }
            div.classList.remove('d-none');
        }, 300);
    }

    let USUARIO_SELECIONADO_CPF = null;
    function selecionarUsuarioBusca(u) {
        USUARIO_SELECIONADO_CPF = u.cpf;
        document.getElementById('resultadosBusca').classList.add('d-none');
        document.getElementById('addPartSearch').value = u.nome;
        
        document.getElementById('selNome').innerText = u.nome;
        document.getElementById('selCpf').innerText = `(CPF: ${u.cpf})`;
        document.getElementById('participanteSelecionado').classList.remove('d-none');
    }

    async function executarInscricaoManual() {
        const activityId = document.getElementById('addPartAtividade').value;

        if (!USUARIO_SELECIONADO_CPF || !activityId) {
            Swal.fire('Erro', 'Selecione um participante e uma atividade.', 'warning');
            return;
        }

        const res = await fetch('/api/inscricao_manual', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ cpf: USUARIO_SELECIONADO_CPF, activity_id: activityId })
        });

        const json = await res.json();
        if (res.ok) {
            mostrarAreaAdicao();
            carregarParticipantes(1);
            Toast.fire({ icon: 'success', title: 'Inscrição realizada!' });
        } else {
            Swal.fire('Falha', json.erro, 'error');
        }
    }

    async function removerInscricao(enrollmentId) {
        const confirm = await Swal.fire({
            title: 'Remover Participante?',
            text: "O aluno será desvinculado desta atividade.",
            icon: 'warning',
            showCancelButton: true
        });
        if (!confirm.isConfirmed) return;

        // Note: I need an endpoint for deleting enrollment. I can use toggle_enrollment or a new one.
        // Let's assume a generic delete enrollment API or repurpose toggle.
        // Actually let's create a specific one in api/events.py for simplicity.
        const res = await fetch(`/api/remover_inscricao/${enrollmentId}`, { method: 'DELETE' });
        if (res.ok) {
            carregarParticipantes(1);
            Toast.fire({ icon: 'success', title: 'Removido com sucesso.' });
        }
    }

    async function carregarParticipantes(page) {
        if (!EVENTO_SELECIONADO_ID) return;
        
        const filters = {
            nome: document.getElementById('filtPartNome').value,
            cpf: document.getElementById('filtPartCpf').value,
            presente: document.getElementById('filtPartPresenca').value,
            page: page
        };
        const params = new URLSearchParams(filters);
        const res = await fetch(`/api/participantes_evento/${EVENTO_SELECIONADO_ID}?${params.toString()}`);
        const data = await res.json();
        
        const tbody = document.getElementById('tabelaParticipantes');
        tbody.innerHTML = '';
        
        if(data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">Nenhum participante encontrado.</td></tr>';
        }

        data.items.forEach(p => {
            const toggleBtn = p.presente 
                ? `<button onclick="alternarPresenca(${p.id}, false)" class="btn btn-xs btn-success rounded-pill px-3"><i class="fa-solid fa-check me-1"></i> Validado</button>`
                : `<button onclick="alternarPresenca(${p.id}, true)" class="btn btn-xs btn-outline-secondary rounded-pill px-3"><i class="fa-solid fa-clock me-1"></i> Pendente</button>`;

            let distHtml = '<span class="text-muted x-small">N/A</span>';
            if (p.distancia !== null) {
                const color = p.distancia > 200 ? 'text-danger' : 'text-success';
                const icon = p.distancia > 200 ? 'fa-triangle-exclamation' : 'fa-location-crosshairs';
                distHtml = `
                    <div class="${color} small fw-bold" title="Coordenadas: ${p.lat_checkin.toFixed(4)}, ${p.lon_checkin.toFixed(4)}">
                        <i class="fa-solid ${icon} me-1"></i>${p.distancia}m
                    </div>
                `;
            }

            tbody.innerHTML += `
                <tr class="animate__animated animate__fadeIn">
                    <td class="ps-4 fw-bold text-dark">${p.nome}</td>
                    <td><small class="font-monospace text-muted">${p.cpf}</small></td>
                    <td><span class="badge bg-light text-dark border">${p.activity_name || p.atividade}</span></td>
                    <td>${toggleBtn}</td>
                    <td>${distHtml}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-xs btn-link text-danger p-0" onclick="removerInscricao(${p.id})"><i class="fa-solid fa-user-xmark"></i></button>
                    </td>
                </tr>
            `;
        });

        renderPaginacao(data.current_page, data.pages, 'paginacaoParticipantes', carregarParticipantes);
    }

    async function alternarPresenca(enrollmentId, status) {
        const res = await fetch(`/api/alternar_presenca/${enrollmentId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({presente: status})
        });
        if (res.ok) {
            carregarParticipantes(1);
            Toast.fire({ icon: 'success', title: 'Presença atualizada!' });
        }
    }

    function renderPaginacao(current, total, containerId, callback) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        if (total <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center m-0';

        const createItem = (page, active = false, disabled = false, text = null) => {
            const li = document.createElement('li');
            li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = text || page;
            if (!disabled) a.onclick = (e) => { e.preventDefault(); callback(page); };
            li.appendChild(a);
            return li;
        };

        ul.appendChild(createItem(current - 1, false, current === 1, '«'));

        const pages = [];
        const range = 1;
        for (let i = 1; i <= total; i++) {
            if (i === 1 || i === total || (i >= current - range && i <= current + range)) {
                pages.push(i);
            } else if (pages[pages.length - 1] !== '...') {
                pages.push('...');
            }
        }

        pages.forEach(p => {
            if (p === '...') ul.appendChild(createItem(null, false, true, '...'));
            else ul.appendChild(createItem(p, p === current));
        });

        ul.appendChild(createItem(current + 1, false, current === total, '»'));
        container.appendChild(ul);
    }

    async function confirmarExcluirEvento(id) {
        const confirm = await Swal.fire({ title: 'Excluir Evento?', text: "Isso removerá todas as atividades e inscrições vinculadas.", icon: 'warning', showCancelButton: true });
        if (!confirm.isConfirmed) return;
        const res = await fetch(`/api/deletar_evento/${id}`, { method: 'DELETE' });
        if (res.ok) { carregarEventos(1); Toast.fire({ icon: 'success', title: 'Evento removido.' }); }
    }

    // Reuse form from dashboard logic if needed or implement a cleaner CRUD modal
    function abrirModalNovoEvento() { 
        // Redirect to dashboard where the creation form is or implement a specialized modal here.
        // For standard "High Standard" admin, a modal is better.
        Swal.fire({
            title: 'Novo Evento',
            text: 'Deseja ir para o painel de criação rápida?',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Sim, ir agora'
        }).then(r => { if(r.isConfirmed) window.location.href = '/'; });
    }
</script>
{% endblock %}
