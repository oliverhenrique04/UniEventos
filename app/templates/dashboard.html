{% extends 'base.html' %}

{% block head_styles %}
<style>
    .event-card {
        border-left: 5px solid #044d84;
        transition: transform 0.2s;
    }
    .event-card:active {
        transform: scale(0.98);
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    /* Scanner Overlay Style */
    #areaCamera {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
    }
    #reader video {
        border-radius: 12px;
        object-fit: cover;
    }
    
    .action-btn-lg {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container fade-in-up">
    
    <!-- GESTOR VIEW (Admin/Professor) -->
    {% if user.role != 'participante' %}
    <div class="row g-4">
        <!-- Events List Column (Primary) -->
        <div class="col-lg-8">
            <div class="d-flex align-items-center justify-content-between mb-4 px-2">
                <h4 class="m-0"><i class="fa-solid fa-calendar-days text-primary me-2"></i>Meus Eventos</h4>
                <div class="d-flex gap-2">
                    <a href="/criar_evento" class="btn btn-sm btn-primary shadow-sm">
                        <i class="fa-solid fa-plus me-1"></i> Criar Completo
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light border dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Filtrar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                            <li><a class="dropdown-item" href="#">Todos</a></li>
                            <li><a class="dropdown-item" href="#">Ativos</a></li>
                            <li><a class="dropdown-item" href="#">Finalizados</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="listaEventosGestor" class="row row-cols-1 row-cols-md-2 g-4">
                <!-- Preenchido via JS -->
            </div>
            <nav class="mt-4"><ul class="pagination justify-content-center" id="paginacaoGestor"></ul></nav>
        </div>

        <!-- Create Event Column (Sidebar on desktop) -->
        <div class="col-lg-4">
            <div class="glass-panel bg-white sticky-top" style="top: 100px; z-index: 10;">
                <h5 class="fw-bold mb-4"><i class="fa-solid fa-plus-circle text-primary me-2"></i>Criar Novo Evento</h5>
                
                <form id="formEvento">
                    <div class="p-3 bg-indigo-50 rounded-4 border border-indigo-100 mb-4">
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="checkRapido" onchange="toggleForm()">
                            <label class="form-check-label fw-bold ms-2" for="checkRapido">‚ö° Evento R√°pido</label>
                        </div>
                        <div class="form-text mt-1 small">Gera um check-in √∫nico e imediato.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">T√≠tulo do Evento</label>
                        <input type="text" class="form-control" id="evNome" placeholder="Ex: Workshop de IA" required>
                    </div>

                    <div id="camposCompletos">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Descri√ß√£o</label>
                            <textarea class="form-control" id="evDesc" rows="3" placeholder="O que acontecer√° no evento?"></textarea>
                        </div>
                        
                        <div class="row g-2 mb-4">
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted">In√≠cio</label>
                                <input type="date" id="evDataIni" class="form-control mb-2">
                                <input type="time" id="evHoraIni" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted">Fim</label>
                                <input type="date" id="evDataFim" class="form-control mb-2">
                                <input type="time" id="evHoraFim" class="form-control">
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="fw-bold small text-uppercase letter-spacing-1">Atividades</label>
                                <button type="button" class="btn btn-sm btn-outline-primary py-1 px-2" onclick="addAtividade('containerAtividades')">
                                    <i class="fa-solid fa-plus me-1"></i> Add
                                </button>
                            </div>
                            <div id="containerAtividades" class="d-grid gap-3"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 shadow-lg">
                        Publicar Evento <i class="fa-solid fa-rocket ms-2"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- PARTICIPANT VIEW -->
    {% if user.role == 'participante' %}
    <div class="row justify-content-center mb-5">
        <div class="col-lg-6 col-md-8 text-center">
            <div class="glass-panel border-top border-5 border-primary py-5 px-4">
                <div class="mb-4">
                    <div class="bg-indigo-50 d-inline-flex p-4 rounded-circle mb-3">
                        <i class="fa-solid fa-qrcode fa-3x text-primary"></i>
                    </div>
                    <h2 class="fw-bold">Confirmar Presen√ßa</h2>
                    <p class="text-muted">Escaneie o c√≥digo din√¢mico da atividade para registrar sua participa√ß√£o e obter seu certificado.</p>
                </div>
                
                <div id="scanControl">
                    <button onclick="iniciarScanner()" class="btn btn-primary btn-lg w-100 rounded-pill py-3 shadow-lg">
                        <i class="fa-solid fa-camera me-2"></i> Iniciar Scanner
                    </button>
                </div>
                
                <div id="areaCamera" class="mt-4 rounded-4 shadow-lg bg-dark overflow-hidden animate__animated animate__fadeIn" style="display:none;">
                    <div id="reader"></div>
                    <button onclick="pararScanner()" class="btn btn-dark w-100 rounded-0 py-3 text-danger fw-bold border-top border-secondary">
                        <i class="fa-solid fa-circle-xmark me-2"></i> Cancelar Escaneamento
                    </button>
                </div>
                
                <div id="feedback" class="mt-4"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 px-4">
            <h4 class="fw-bold mb-4 px-2"><i class="fa-solid fa-bolt text-warning me-2"></i>Eventos Dispon√≠veis</h4>
            <div id="listaEventosAluno" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <!-- Preenchido via JS -->
            </div>
            <nav class="mt-4"><ul class="pagination justify-content-center" id="paginacaoAluno"></ul></nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- MODALS (Refined) -->
<div class="modal fade" id="modalRelatorio" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-clipboard-user me-2"></i>Lista de Presen√ßa</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="corpoRelatorio">
                <!-- Conte√∫do injetado via JS -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarEvento" tabindex="-1">
    <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle text-warning-emphasis">
                <h5 class="modal-title fw-bold">Editar Evento</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEvId">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="editEvNome" placeholder="Nome">
                    <label>Nome do Evento</label>
                </div>
                <div class="form-floating mb-3">
                    <textarea class="form-control" id="editEvDesc" style="height: 100px" placeholder="Desc"></textarea>
                    <label>Descri√ß√£o</label>
                </div>
                <div class="row g-2 mb-4">
                    <div class="col-6"><label class="small text-muted">In√≠cio</label><input type="date" id="editDataIni" class="form-control mb-1"><input type="time" id="editHoraIni" class="form-control"></div>
                    <div class="col-6"><label class="small text-muted">Fim</label><input type="date" id="editDataFim" class="form-control mb-1"><input type="time" id="editHoraFim" class="form-control"></div>
                </div>
                <h6 class="border-bottom pb-2 mb-3 fw-bold">Atividades</h6>
                <div id="containerAtividadesEdit" class="d-grid gap-2"></div>
                <button class="btn btn-outline-primary w-100 mt-3 border-dashed" onclick="addAtividade('containerAtividadesEdit')">+ Adicionar Atividade</button>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button onclick="salvarEdicaoEvento()" class="btn btn-warning px-4 fw-bold">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalProjetor" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark text-white text-center">
            <button class="btn btn-dark position-absolute top-0 end-0 m-3 rounded-circle fs-4" onclick="fecharProjetor()"><i class="fa-solid fa-xmark"></i></button>
            <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                <h2 class="text-warning mb-4 display-4 fw-bold">Check-in</h2>
                <div class="w-100" style="max-width: 500px;">
                    <select id="selectAtividadeProjetor" class="form-select form-select-lg text-center fw-bold rounded-pill mb-4" onchange="mudarAtividadeProjetor()"></select>
                </div>
                <div id="qrContainer" class="bg-white p-4 rounded-4 shadow-lg d-none animate__animated animate__zoomIn">
                    <img id="imgQrDinamico" src="" style="height: min(50vh, 500px); width: min(50vh, 500px); object-fit: contain;">
                </div>
                <div id="msgSelect" class="text-white-50 p-5 border border-secondary rounded-4 border-dashed">
                    <h4>‚¨ÖÔ∏è Selecione a atividade</h4>
                </div>
                <p class="text-white-50 mt-4 d-none fs-5" id="timerContainer">Atualizando em: <span id="timerDisplay" class="text-info fw-bold">30s</span></p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditUser" tabindex="-1">

{% endblock %}

{% block scripts %}
<script>
    const userRole = "{{ user.role }}";
    let intervaloQR = null;
    let atividadeAtualID = null;
    let EVENTO_SELECIONADO_ID = null;
    let CACHE_EVENTOS = [];

    document.addEventListener("DOMContentLoaded", () => {
        if(userRole === 'admin') carregarUsuarios();
        if(userRole !== 'participante') carregarEventosGestor();
        if(userRole === 'participante') carregarEventosAluno();
        
        const dIni = document.getElementById('evDataIni');
        if(dIni) { 
            dIni.min = new Date().toISOString().split('T')[0];
            dIni.addEventListener('change', () => { 
                if(document.getElementById('evDataFim')) document.getElementById('evDataFim').min = dIni.value; 
            }); 
        }
    });

    // --- SCANNER OTIMIZADO ---
    let scanner = null;
    function iniciarScanner() {
        document.getElementById('scanControl').style.display = 'none';
        document.getElementById('areaCamera').style.display = 'block';
        document.getElementById('feedback').innerHTML = "";
        
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };
        
        scanner = new Html5QrcodeScanner("reader", config, false);
        scanner.render(onScanSuccess, (err) => console.log(err));
    }

    function pararScanner() {
        if(scanner) { scanner.clear().catch(error => console.error(error)); }
        document.getElementById('areaCamera').style.display = 'none';
        document.getElementById('scanControl').style.display = 'block';
    }

    async function onScanSuccess(decodedText) {
        scanner.clear(); 
        document.getElementById('areaCamera').style.display = 'none'; 
        document.getElementById('feedback').innerHTML = '<div class="d-flex align-items-center justify-content-center p-3 glass-panel"><div class="spinner-border text-primary me-3"></div> Verificando c√≥digo...</div>';
        
        try {
            const res = await fetch('/api/validar_presenca', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({token: decodedText}) 
            });
            const json = await res.json();
            
            if(json.status === 'success') {
                document.getElementById('feedback').innerHTML = `
                    <div class="text-center animate__animated animate__fadeInUp">
                        <div class="mb-3 text-success" style="font-size: 3rem;"><i class="fa-solid fa-circle-check"></i></div>
                        <h4 class="fw-bold text-dark">Presen√ßa Confirmada!</h4>
                        <p class="text-muted">Seu certificado j√° est√° dispon√≠vel.</p>
                        <a href="${json.download_link}" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">
                            <i class="fa-solid fa-download me-2"></i> Baixar Certificado
                        </a>
                        <button onclick="iniciarScanner()" class="btn btn-link text-secondary mt-2">Escanear outro c√≥digo</button>
                    </div>`;
                document.getElementById('scanControl').style.display = 'none';
            } else {
                throw new Error(json.erro || "C√≥digo inv√°lido");
            }
        } catch (e) {
            document.getElementById('feedback').innerHTML = `
                <div class="alert alert-danger border-0 shadow-sm text-center">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i> ${e.message}
                </div>`;
            setTimeout(() => { 
                document.getElementById('feedback').innerHTML = ""; 
                document.getElementById('scanControl').style.display = 'block'; 
            }, 4000);
        }
    }

    // --- FORMUL√ÅRIOS E GEST√ÉO ---
    function addAtividade(containerId) {
        const div = document.createElement('div'); 
        div.className = 'card border-0 shadow-sm mb-2 position-relative';
        div.style.background = '#f8f9fa';
        div.innerHTML = `
            <div class="card-body p-3">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" onclick="this.closest('.card').remove()"></button>
                <div class="row g-2 mb-2">
                    <div class="col-8"><input type="text" class="form-control form-control-sm atv-nome fw-bold" placeholder="Nome da Atividade" required></div>
                    <div class="col-4"><input type="number" class="form-control form-control-sm atv-horas" placeholder="Horas"></div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><input type="date" class="form-control form-control-sm atv-data"></div>
                    <div class="col-6"><input type="time" class="form-control form-control-sm atv-hora"></div>
                </div>
                <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text bg-white"><i class="fa-solid fa-users"></i></span>
                    <input type="number" class="form-control atv-vagas" placeholder="Vagas">
                    <div class="input-group-text bg-white">
                        <input class="form-check-input mt-0 atv-unlim" type="checkbox" onchange="toggleAtvVagas(this)"> <small class="ms-1">‚àû</small>
                    </div>
                </div>
                <input type="text" class="form-control form-control-sm mb-2 atv-local" placeholder="üìç Local / Sala">
                <input type="text" class="form-control form-control-sm mb-2 atv-palestrante" placeholder="üé§ Palestrante">
                <textarea class="form-control form-control-sm atv-desc" placeholder="Breve descri√ß√£o" rows="1"></textarea>
            </div>`;
        document.getElementById(containerId).appendChild(div);
    }

    function toggleAtvVagas(cb) { 
        const input = cb.closest('.input-group').querySelector('.atv-vagas'); 
        input.disabled = cb.checked; 
        if(cb.checked) input.value = ''; 
    }

    function coletarAtividades(containerId) {
        let lista = [];
        document.querySelectorAll(`#${containerId} .card`).forEach(el => {
            const isUnlim = el.querySelector('.atv-unlim').checked;
            lista.push({
                nome: el.querySelector('.atv-nome').value, 
                horas: el.querySelector('.atv-horas').value, 
                vagas: isUnlim ? -1 : el.querySelector('.atv-vagas').value, 
                data_atv: el.querySelector('.atv-data').value, 
                hora_atv: el.querySelector('.atv-hora').value, 
                local: el.querySelector('.atv-local').value, 
                palestrante: el.querySelector('.atv-palestrante').value, 
                descricao: el.querySelector('.atv-desc').value
            });
        }); 
        return lista;
    }

    document.getElementById('formEvento')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Criando...'; btn.disabled = true;

        const data = { 
            nome: document.getElementById('evNome').value, 
            descricao: document.getElementById('evDesc').value, 
            is_rapido: document.getElementById('checkRapido').checked, 
            data_inicio: document.getElementById('evDataIni').value, 
            hora_inicio: document.getElementById('evHoraIni').value, 
            data_fim: document.getElementById('evDataFim').value, 
            hora_fim: document.getElementById('evHoraFim').value, 
            atividades: coletarAtividades('containerAtividades') 
        };
        
        try {
            const res = await fetch('/api/criar_evento', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
            const json = await res.json();
            if(res.ok) { 
                document.getElementById('formEvento').reset(); 
                document.getElementById('containerAtividades').innerHTML = ''; 
                carregarEventosGestor();
                Toast.fire({icon: 'success', title: 'Evento criado com sucesso!'});
            } else {
                Swal.fire('Erro', json.erro, 'error');
            }
        } finally {
            btn.innerHTML = originalText; btn.disabled = false;
        }
    });

    // --- PROJETOR & GESTOR ---
    function abrirProjetor(idEvento) {
        const ev = CACHE_EVENTOS.find(e => e.id == idEvento); if(!ev) return;
        const select = document.getElementById('selectAtividadeProjetor');
        select.innerHTML = '<option value="" disabled selected>-- Escolha a Atividade --</option>';
        ev.atividades.forEach(a => select.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        atividadeAtualID = null; 
        document.getElementById('qrContainer').classList.add('d-none'); 
        document.getElementById('timerContainer').classList.add('d-none'); 
        document.getElementById('msgSelect').classList.remove('d-none'); 
        new bootstrap.Modal(document.getElementById('modalProjetor')).show();
        if (ev.atividades.length === 1) { select.selectedIndex = 1; mudarAtividadeProjetor(); }
    }

    function mudarAtividadeProjetor() {
        atividadeAtualID = document.getElementById('selectAtividadeProjetor').value;
        document.getElementById('msgSelect').classList.add('d-none'); 
        document.getElementById('qrContainer').classList.remove('d-none'); 
        document.getElementById('timerContainer').classList.remove('d-none');
        atualizarQR(true); 
        if(intervaloQR) clearInterval(intervaloQR); 
        intervaloQR = setInterval(() => atualizarQR(false), 1000);
    }

    function atualizarQR(force) {
        if(!atividadeAtualID) return; 
        const restante = 30 - (new Date().getSeconds() % 30); 
        document.getElementById('timerDisplay').innerText = `${restante}s`;
        if (force || restante === 30) { 
            document.getElementById('imgQrDinamico').src = `/api/qrcode_atividade/${atividadeAtualID}?t=${new Date().getTime()}`; 
        }
    }

    function fecharProjetor() { 
        clearInterval(intervaloQR); 
        bootstrap.Modal.getInstance(document.getElementById('modalProjetor')).hide(); 
    }

    // --- RENDERIZADORES ---
    async function carregarEventosGestor(page = 1) {
        const res = await fetch(`/api/eventos?page=${page}`); 
        const data = await res.json();
        CACHE_EVENTOS = data.items;
        const div = document.getElementById('listaEventosGestor'); 
        div.innerHTML = '';
        
        if(CACHE_EVENTOS.length === 0) {
            div.innerHTML = '<div class="col-12 text-center text-muted py-5 px-4 glass-panel border-dashed"><i class="fa-regular fa-calendar-plus fs-1 mb-3 text-slate-300"></i><p>Voc√™ ainda n√£o criou nenhum evento. Use o formul√°rio ao lado!</p></div>';
            return;
        }

        CACHE_EVENTOS.forEach(ev => {
            div.innerHTML += `
                <div class="col animate__animated animate__fadeIn">
                    <div class="glass-panel h-100 p-0 overflow-hidden d-flex flex-column border-top border-4 border-primary">
                        <div class="p-3 bg-slate-50 border-bottom d-flex justify-content-between align-items-center">
                            <span class="badge bg-indigo-50 text-indigo-600 border border-indigo-100">
                                <i class="fa-solid fa-layer-group me-1"></i> ${ev.atividades.length} Atividades
                            </span>
                            <div class="small fw-bold text-slate-500">
                                <i class="fa-regular fa-calendar me-1"></i> ${ev.data_inicio.split('-').reverse().join('/') || '--/--/--'}
                            </div>
                        </div>
                        <div class="p-4 flex-grow-1">
                            <h5 class="fw-bold text-slate-900 mb-2">${ev.nome}</h5>
                            <p class="text-muted small mb-0" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${ev.descricao || 'Nenhuma descri√ß√£o fornecida.'}
                            </p>
                        </div>
                        <div class="p-3 bg-white border-top d-flex gap-2">
                            <button onclick="abrirRelatorio(${ev.id})" class="btn btn-sm btn-light border flex-grow-1" title="Lista de Inscritos">
                                <i class="fa-solid fa-users-viewfinder me-1"></i> Relat√≥rio
                            </button>
                            <a href="/designer_certificado/${ev.id}" class="btn btn-sm btn-light border" title="Designer de Certificado">
                                <i class="fa-solid fa-certificate"></i>
                            </a>
                            <button onclick="abrirProjetor(${ev.id})" class="btn btn-primary btn-sm rounded-pill px-4 shadow-sm">
                                <i class="fa-solid fa-display me-1"></i> Projetar
                            </button>
                        </div>
                    </div>
                </div>`;
        });
        
        renderPaginacao(data.current_page, data.pages, 'paginacaoGestor', carregarEventosGestor);
    }

    async function carregarEventosAluno(page = 1) {
        const res = await fetch(`/api/eventos?page=${page}`); 
        const data = await res.json(); 
        const div = document.getElementById('listaEventosAluno'); 
        div.innerHTML = '';
        
        if(data.items.length === 0) {
            div.innerHTML = '<div class="col-12 text-center text-muted py-5 px-4 glass-panel border-dashed"><i class="fa-regular fa-calendar-xmark fs-1 mb-3 text-slate-300"></i><p>Nenhum evento dispon√≠vel para inscri√ß√£o no momento.</p></div>';
            return;
        }

        data.items.forEach(ev => {
            let htmlAtividades = '';
            ev.atividades.forEach(a => {
                const isFull = a.vagas !== -1 && a.total_inscritos >= a.vagas;
                const btnClass = a.inscrito ? 'btn-danger bg-danger bg-opacity-10 text-danger border-danger' : (isFull ? 'btn-light disabled' : 'btn-outline-primary'); 
                const btnText = a.inscrito ? '<i class="fa-solid fa-user-minus me-1"></i> Sair' : (isFull ? '<i class="fa-solid fa-ban me-1"></i> Esgotado' : '<i class="fa-solid fa-user-plus me-1"></i> Inscrever'); 
                const acao = a.inscrito ? 'sair' : 'inscrever';
                
                let vagasStatus = '';
                if (a.vagas == -1) {
                    vagasStatus = '<span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-2"><i class="fa-solid fa-infinity me-1"></i> LIVRE</span>';
                } else {
                    const perc = Math.round((a.total_inscritos / a.vagas) * 100);
                    const color = perc > 90 ? 'danger' : (perc > 70 ? 'warning' : 'primary');
                    vagasStatus = `<span class="badge bg-${color}-subtle text-${color} border border-${color}-subtle rounded-pill px-2">${a.vagas - a.total_inscritos} vagas</span>`;
                }
                
                htmlAtividades += `
                    <div class="p-3 bg-white rounded-4 mb-3 border shadow-sm transition-fast ${a.inscrito ? 'border-primary' : ''}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="pe-2">
                                <h6 class="fw-bold mb-1 ${a.inscrito ? 'text-primary' : 'text-slate-800'}">${a.nome}</h6>
                                <div class="text-muted d-flex flex-wrap gap-2" style="font-size: 0.7rem;">
                                    <span class="d-flex align-items-center"><i class="fa-regular fa-clock me-1 text-primary-300"></i>${a.carga_horaria}h</span>
                                    <span class="d-flex align-items-center"><i class="fa-solid fa-location-dot me-1 text-primary-300"></i>${a.local || 'Audit√≥rio'}</span>
                                    ${a.palestrante ? `<span class="d-flex align-items-center"><i class="fa-solid fa-user-tie me-1 text-primary-300"></i>${a.palestrante}</span>` : ''}
                                </div>
                            </div>
                            ${vagasStatus}
                        </div>
                        <button onclick="toggleInscricao(${a.id}, '${acao}')" class="btn btn-sm ${btnClass} w-100 mt-2 py-2 fw-bold text-uppercase rounded-pill" style="font-size: 0.65rem; letter-spacing: 0.5px;">${btnText}</button>
                    </div>`;
            }); 
            
            div.innerHTML += `
                <div class="col animate__animated animate__fadeIn">
                    <div class="glass-panel h-100 p-0 border-0 shadow-lg overflow-hidden d-flex flex-column">
                        <div class="p-4 bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-white bg-opacity-20 text-color-primary border-0 small text-uppercase fw-bold" style="letter-spacing: 1px;">EVENTO</span>
                                <small class="fw-bold opacity-75"><i class="fa-regular fa-calendar-days me-1"></i>${ev.data_inicio.split('-').reverse().join('/')}</small>
                            </div>
                            <h5 class="fw-bold m-0 fs-5">${ev.nome}</h5>
                        </div>
                        <div class="p-4 flex-grow-1 bg-slate-50">
                            <p class="text-muted small mb-4" style="line-height: 1.6;">${ev.descricao || 'Participe deste evento acad√™mico e emita seu certificado de horas complementares.'}</p>
                            
                            <div class="atividades-list">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <label class="small fw-bold text-slate-400 text-uppercase letter-spacing-1">Programa√ß√£o</label>
                                    <span class="badge bg-slate-200 text-slate-600 rounded-pill">${ev.atividades.length}</span>
                                </div>
                                ${htmlAtividades}
                            </div>
                        </div>
                    </div>
                </div>`;
        });

        renderPaginacao(data.current_page, data.pages, 'paginacaoAluno', carregarEventosAluno);
    }

    function renderPaginacao(current, total, containerId, callback) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        if (total <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination pagination-sm m-0';

        const createItem = (page, active = false, disabled = false, text = null) => {
            const li = document.createElement('li');
            li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.innerText = text || page;
            if (!disabled) a.onclick = (e) => { e.preventDefault(); callback(page); };
            li.appendChild(a);
            return li;
        };

        ul.appendChild(createItem(current - 1, false, current === 1, '¬´'));

        const pages = [];
        const range = 1;
        for (let i = 1; i <= total; i++) {
            if (i === 1 || i === total || (i >= current - range && i <= current + range)) {
                pages.push(i);
            } else if (pages[pages.length - 1] !== '...') {
                pages.push('...');
            }
        }

        pages.forEach(p => {
            if (p === '...') ul.appendChild(createItem(null, false, true, '...'));
            else ul.appendChild(createItem(p, p === current));
        });

        ul.appendChild(createItem(current + 1, false, current === total, '¬ª'));
        container.appendChild(ul);
    }

    async function toggleInscricao(atvId, acao) { 
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        try {
            const res = await fetch('/api/toggle_inscricao', {
                method: 'POST', 
                headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify({activity_id: atvId, acao: acao})
            }); 
            const json = await res.json(); 
            if(res.ok) {
                carregarEventosAluno();
                Toast.fire({icon: 'success', title: json.mensagem});
            } else {
                Swal.fire('Aten√ß√£o', json.erro || json.mensagem, 'warning');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch (e) {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // --- ADMIN ---
    async function carregarUsuarios() { 
        const res = await fetch('/api/listar_usuarios'); 
        const users = await res.json(); 
        const tbody = document.getElementById('listaUsuarios'); 
        tbody.innerHTML = ''; 
        users.forEach(u => {
            let roleBadge = '';
            switch(u.role) {
                case 'admin': roleBadge = '<span class="badge bg-danger">Admin</span>'; break;
                case 'professor': roleBadge = '<span class="badge bg-warning text-dark">Professor</span>'; break;
                case 'coordenador': roleBadge = '<span class="badge bg-info text-dark">Coordenador</span>'; break;
                default: roleBadge = '<span class="badge bg-slate-200 text-slate-700">Participante</span>';
            }
            tbody.innerHTML += `
                <tr class="animate__animated animate__fadeIn">
                    <td>
                        <div class="fw-bold text-dark">${u.username}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">${u.email || 'sem e-mail'}</div>
                    </td>
                    <td>${u.nome} <br> <small class="text-muted">${u.cpf}</small></td>
                    <td>${roleBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-light border" onclick="abrirEditUser('${u.username}', '${u.nome}', '${u.cpf}', '${u.role}', '${u.email || ''}')">
                            <i class="fa-solid fa-pen-to-square text-primary"></i>
                        </button>
                    </td>
                </tr>`; 
        }); 
    }
    
    // Admin Edit Utils
    function abrirEditUser(u, n, c, r, e) { 
        document.getElementById('editUsername').value = u; 
        document.getElementById('editNome').value = n; 
        document.getElementById('editCpf').value = c; 
        document.getElementById('editRole').value = r; 
        document.getElementById('editEmail').value = e; // Assuming field added to modal
        new bootstrap.Modal(document.getElementById('modalEditUser')).show(); 
    }
    async function salvarEdicaoUsuario() { 
        const data = {
            username_alvo: document.getElementById('editUsername').value, 
            nome: document.getElementById('editNome').value, 
            cpf: document.getElementById('editCpf').value, 
            role: document.getElementById('editRole').value,
            email: document.getElementById('editEmail').value
        }; 
        const res = await fetch('/api/editar_usuario', {method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); 
        if(res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide(); 
            carregarUsuarios();
            Toast.fire({icon: 'success', title: 'Usu√°rio atualizado com sucesso!'});
        } else {
            const json = await res.json();
            Swal.fire({ icon: 'error', title: 'Erro ao salvar', text: json.erro || 'Falha ao atualizar usu√°rio.' });
        }
    }
    
    function toggleForm() { document.getElementById('camposCompletos').style.display = document.getElementById('checkRapido').checked ? 'none' : 'block'; }
    
    // Edi√ß√£o Evento
    function abrirModalEdicao(id) { const ev = CACHE_EVENTOS.find(e => e.id == id); if(!ev) return; document.getElementById('editEvId').value = ev.id; document.getElementById('editEvNome').value = ev.nome; document.getElementById('editEvDesc').value = ev.descricao; document.getElementById('editDataIni').value = ev.data_inicio; document.getElementById('editHoraIni').value = ev.hora_inicio; document.getElementById('editDataFim').value = ev.data_fim; document.getElementById('editHoraFim').value = ev.hora_fim; const container = document.getElementById('containerAtividadesEdit'); container.innerHTML = ''; ev.atividades.forEach(a => { addAtividade('containerAtividadesEdit'); const card = container.lastElementChild; card.querySelector('.atv-nome').value = a.nome; card.querySelector('.atv-horas').value = a.carga_horaria; const checkUnlim = card.querySelector('.atv-unlim'); const inputVagas = card.querySelector('.atv-vagas'); if (a.vagas == -1) { checkUnlim.checked = true; inputVagas.disabled = true; inputVagas.value = ''; } else { checkUnlim.checked = false; inputVagas.disabled = false; inputVagas.value = a.vagas; } card.querySelector('.atv-data').value = a.data_atv; card.querySelector('.atv-hora').value = a.hora_atv; card.querySelector('.atv-local').value = a.local; card.querySelector('.atv-palestrante').value = a.palestrante; card.querySelector('.atv-desc').value = a.descricao; }); new bootstrap.Modal(document.getElementById('modalEditarEvento')).show(); }
    async function salvarEdicaoEvento() { 
        const data = { 
            id: document.getElementById('editEvId').value, 
            nome: document.getElementById('editEvNome').value, 
            descricao: document.getElementById('editEvDesc').value, 
            data_inicio: document.getElementById('editDataIni').value, 
            hora_inicio: document.getElementById('editHoraIni').value, 
            data_fim: document.getElementById('editDataFim').value, 
            hora_fim: document.getElementById('editHoraFim').value, 
            atividades: coletarAtividades('containerAtividadesEdit') 
        }; 
        const res = await fetch('/api/editar_evento', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}); 
        if(res.ok) { 
            bootstrap.Modal.getInstance(document.getElementById('modalEditarEvento')).hide(); 
            carregarEventosGestor(); 
            Toast.fire({icon: 'success', title: 'Evento atualizado!'});
        } else {
            Swal.fire('Erro', 'N√£o foi poss√≠vel salvar as altera√ß√µes.', 'error');
        }
    }
    async function abrirRelatorio(evtId) { 
        EVENTO_SELECIONADO_ID = evtId;
        new bootstrap.Modal(document.getElementById('modalRelatorio')).show(); 
        carregarDadosRelatorio(1);
    }

    async function carregarDadosRelatorio(page = 1) {
        const corpo = document.getElementById('corpoRelatorio');
        const termo = document.getElementById('searchRelatorio')?.value || '';
        
        corpo.innerHTML = `
            <div class="p-4 bg-slate-50 border-bottom">
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" id="searchRelatorio" class="form-control border-start-0 ps-0 fs-6" placeholder="Buscar participante pelo nome..." value="${termo}" oninput="carregarDadosRelatorio(1)">
                </div>
            </div>
            <div id="listaRelatorio" class="list-group list-group-flush" style="min-height: 300px;">
                <div class="p-5 text-center"><div class="spinner-border text-primary"></div></div>
            </div>
            <div class="p-3 border-top bg-slate-50 d-flex justify-content-center" id="paginacaoRelatorio"></div>
        `;

        try {
            const res = await fetch(`/api/relatorio_inscritos/${EVENTO_SELECIONADO_ID}?page=${page}&q=${encodeURIComponent(termo)}`);
            const data = await res.json();
            const lista = document.getElementById('listaRelatorio');
            lista.innerHTML = '';

            if (data.items.length === 0) {
                lista.innerHTML = `
                    <div class="p-5 text-center text-muted animate__animated animate__fadeIn">
                        <i class="fa-solid fa-user-slash fa-3x mb-3 text-slate-200"></i>
                        <p class="fw-bold">Nenhum participante encontrado.</p>
                        <small>Tente mudar o termo da busca ou selecione outro evento.</small>
                    </div>`;
                return;
            }

            data.items.forEach(i => {
                const status = i.presente 
                    ? '<span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill"><i class="fa-solid fa-circle-check me-1"></i> Validado</span>' 
                    : '<span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill"><i class="fa-solid fa-clock me-1"></i> Ausente</span>';
                
                lista.innerHTML += `
                    <div class="list-group-item ps-4 py-3 d-flex justify-content-between align-items-center border-0 border-bottom animate__animated animate__fadeIn">
                        <div class="pe-3">
                            <div class="fw-bold text-slate-900 fs-6">${i.nome}</div>
                            <div class="text-muted d-flex align-items-center gap-2" style="font-size: 0.75rem;">
                                <span><i class="fa-solid fa-fingerprint me-1 text-slate-300"></i>${i.cpf}</span>
                                <span class="text-slate-200">|</span>
                                <span class="text-primary fw-semibold"><i class="fa-solid fa-tag me-1 text-primary-300"></i>${i.activity_name || i.atividade}</span>
                            </div>
                        </div>
                        ${status}
                    </div>`;
            });

            renderPaginacao(data.current_page, data.pages, 'paginacaoRelatorio', carregarDadosRelatorio);
            
            if(termo) {
                const input = document.getElementById('searchRelatorio');
                input.focus();
                input.setSelectionRange(termo.length, termo.length);
            }
        } catch (e) {
            corpo.innerHTML = '<div class="alert alert-danger m-4 rounded-4"><i class="fa-solid fa-circle-exclamation me-2"></i>Erro ao carregar dados do servidor.</div>';
        }
    }

</script>
{% endblock %}