{% extends 'base.html' %}

{% block head_styles %}
<style>
    body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; height: auto; display: block; }
    .glass-panel { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: none; }
    .atv-card { background: #f8f9fa; border-left: 4px solid #0d6efd; margin-bottom: 8px; padding: 10px; border-radius: 4px; }
    .atv-card.subscribed { border-left-color: #198754; background: #e8f5e9; }
    #reader video { object-fit: cover; border-radius: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="container pb-5">
    {% if user.role == 'admin' %}
    <div class="glass-panel p-4 mb-4 border-start border-5 border-danger">
        <h5 class="text-danger mb-3">Painel Admin</h5>
        <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Login</th><th>Nome</th><th>Cargo</th><th>A√ß√£o</th></tr></thead><tbody id="listaUsuarios"></tbody></table></div>
    </div>
    {% endif %}

    {% if user.role != 'participante' %}
    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="glass-panel p-4 h-100">
                <h5 class="text-primary mb-3">Novo Evento</h5>
                <form id="formEvento">
                    <div class="form-check form-switch mb-3 bg-light p-2 rounded"><input class="form-check-input" type="checkbox" id="checkRapido" onchange="toggleForm()"><label class="form-check-label fw-bold" for="checkRapido">‚ö° Evento R√°pido</label></div>
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="evNome" placeholder="Nome" required><label>Nome do Evento</label></div>
                    <div id="camposCompletos">
                        <div class="form-floating mb-3"><textarea class="form-control" id="evDesc" style="height: 80px"></textarea><label>Descri√ß√£o</label></div>
                        <div class="row g-2 mb-3"><div class="col-6"><label class="small fw-bold">In√≠cio</label><input type="date" id="evDataIni" class="form-control mb-1"><input type="time" id="evHoraIni" class="form-control"></div><div class="col-6"><label class="small fw-bold">Fim</label><input type="date" id="evDataFim" class="form-control mb-1"><input type="time" id="evHoraFim" class="form-control"></div></div>
                        <div class="border p-2 rounded bg-light mb-3"><label class="fw-bold small mb-2">Atividades</label><div id="containerAtividades"></div><button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="addAtividade('containerAtividades')"><i class="fa-solid fa-plus"></i> Add Atividade</button></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Criar Evento</button>
                </form>
            </div>
        </div>
        <div class="col-lg-7 mb-4"><div class="glass-panel p-4 h-100"><h5 class="text-secondary mb-3">Meus Eventos</h5><div id="listaEventosGestor"></div></div></div>
    </div>
    {% endif %}

    {% if user.role == 'participante' %}
    <div class="glass-panel p-5 text-center mb-5 border-top border-5 border-success">
        <h3 class="mb-3">Presen√ßa</h3>
        <div id="scanControl">
            <button onclick="iniciarScanner()" class="btn btn-success btn-lg shadow rounded-pill px-5">
                <i class="fa-solid fa-qrcode me-2"></i> Abrir Leitor QR
            </button>
        </div>
        <div id="areaCamera" class="mt-4 mx-auto p-3 bg-white border rounded shadow-sm" style="display:none; max-width: 600px;">
            <h6 class="text-muted mb-2">Aponte para o c√≥digo</h6>
            <div id="reader"></div>
            <button onclick="pararScanner()" class="btn btn-outline-danger w-100 mt-3">Fechar C√¢mera</button>
        </div>
        <div id="feedback" class="mt-3 fw-bold fs-5"></div>
    </div>
    <h5 class="text-muted border-bottom pb-2 mb-3">Grade de Atividades</h5>
    <div id="listaEventosAluno" class="row"></div>
    {% endif %}
</div>

<div class="modal fade" id="modalRelatorio" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Lista de Presen√ßa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="corpoRelatorio"></div></div></div></div>
<div class="modal fade" id="modalEditarEvento" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning-subtle"><h5 class="modal-title">Editar Evento</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editEvId"><input type="text" class="form-control mb-2 fw-bold" id="editEvNome"><textarea class="form-control mb-2" id="editEvDesc" rows="2"></textarea><div class="row g-2 mb-3"><div class="col-3"><input type="date" id="editDataIni" class="form-control"></div><div class="col-3"><input type="time" id="editHoraIni" class="form-control"></div><div class="col-3"><input type="date" id="editDataFim" class="form-control"></div><div class="col-3"><input type="time" id="editHoraFim" class="form-control"></div></div><hr><h6>Atividades</h6><div id="containerAtividadesEdit"></div><button class="btn btn-sm btn-outline-primary mt-2" onclick="addAtividade('containerAtividadesEdit')">+ Adicionar</button></div><div class="modal-footer"><button onclick="salvarEdicaoEvento()" class="btn btn-primary">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalProjetor" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content bg-dark text-white text-center"><div class="modal-body d-flex flex-column justify-content-center align-items-center"><h2 class="text-warning mb-3">Check-in de Atividade</h2><div class="w-50 mb-4"><select id="selectAtividadeProjetor" class="form-select form-select-lg text-center fw-bold" onchange="mudarAtividadeProjetor()"></select></div><div id="qrContainer" class="bg-white p-3 rounded d-none"><img id="imgQrDinamico" src="" style="height: 45vh; width: 45vh; object-fit: contain;"></div><div id="msgSelect" class="text-white-50 p-5 border border-secondary rounded"><h4>‚¨ÖÔ∏è Selecione uma atividade para gerar o c√≥digo</h4></div><p class="lead text-white-50 mt-4 d-none" id="timerContainer">Atualizando em: <span id="timerDisplay" class="text-info fw-bold">30s</span></p><button class="btn btn-outline-danger mt-4 btn-lg px-5 rounded-pill" onclick="fecharProjetor()">Encerrar</button></div></div></div></div>
<div class="modal fade" id="modalEditUser" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Editar Usu√°rio</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editUsername"><div class="mb-2"><label>Nome</label><input type="text" id="editNome" class="form-control"></div><div class="mb-2"><label>CPF</label><input type="text" id="editCpf" class="form-control"></div><div class="mb-2"><label>Cargo</label><select id="editRole" class="form-select"><option value="participante">Participante</option><option value="professor">Professor</option><option value="coordenador">Coordenador</option><option value="admin">Admin</option></select></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="salvarEdicaoUsuario()">Salvar</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
    const userRole = "{{ user.role }}";
    let intervaloQR = null;
    let atividadeAtualID = null;
    let CACHE_EVENTOS = [];

    document.addEventListener("DOMContentLoaded", () => {
        if(userRole === 'admin') carregarUsuarios();
        if(userRole !== 'participante') carregarEventosGestor();
        if(userRole === 'participante') carregarEventosAluno();
        
        const hoje = new Date().toISOString().split('T')[0];
        const dIni = document.getElementById('evDataIni');
        if(dIni) { dIni.min = hoje; dIni.addEventListener('change', () => { if(document.getElementById('evDataFim')) document.getElementById('evDataFim').min = dIni.value; }); }
    });

    // --- SCANNER OTIMIZADO ---
    let scanner = null;
    function iniciarScanner() {
        document.getElementById('scanControl').style.display = 'none';
        document.getElementById('areaCamera').style.display = 'block';
        document.getElementById('feedback').innerHTML = "";
        if(scanner) scanner.clear();
        scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: { width: 300, height: 300 }, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA], formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] }, false);
        scanner.render(onScanSuccess, (errorMessage) => {});
    }
    function pararScanner() {
        if(scanner) { scanner.clear().catch(error => console.error("Falha ao parar", error)); }
        document.getElementById('areaCamera').style.display = 'none';
        document.getElementById('scanControl').style.display = 'block';
    }
    async function onScanSuccess(decodedText) {
        scanner.clear(); document.getElementById('areaCamera').style.display = 'none'; document.getElementById('feedback').innerHTML = '<div class="spinner-border text-primary"></div> Verificando...';
        try {
            const res = await fetch('/api/validar_presenca', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({token: decodedText}) });
            const json = await res.json();
            if(json.status === 'success') {
                document.getElementById('feedback').innerHTML = `<div class="text-center mt-3"><h4 class="text-success fw-bold">‚úÖ Presen√ßa Confirmada!</h4><a href="${json.download_link}" class="btn btn-success btn-lg mt-2 shadow fw-bold"><i class="fa-solid fa-file-pdf"></i> BAIXAR CERTIFICADO</a></div><button onclick="iniciarScanner()" class="btn btn-outline-primary mt-3">Escanear Outro</button>`;
                document.getElementById('scanControl').style.display = 'none';
            } else {
                document.getElementById('feedback').innerHTML = `<span class="text-danger fw-bold fs-4">‚ùå ${json.erro}</span>`;
                setTimeout(() => { document.getElementById('feedback').innerHTML = ""; document.getElementById('scanControl').style.display = 'block'; }, 3000);
            }
        } catch (e) { document.getElementById('feedback').innerHTML = `<span class="text-danger">Erro de conex√£o.</span>`; document.getElementById('scanControl').style.display = 'block'; }
    }

    // --- FORMUL√ÅRIOS E GEST√ÉO ---
    function addAtividade(containerId) {
        const div = document.createElement('div'); div.className = 'card p-2 mb-2 bg-white border';
        div.innerHTML = `<div class="row g-1 mb-1"><div class="col-6"><input type="text" class="form-control form-control-sm atv-nome fw-bold" placeholder="Nome"></div><div class="col-3"><input type="number" class="form-control form-control-sm atv-horas" placeholder="Horas"></div><div class="col-3"><div class="input-group input-group-sm"><div class="input-group-text p-1"><input class="form-check-input mt-0 atv-unlim" type="checkbox" onchange="toggleAtvVagas(this)"><small class="ms-1">‚àû</small></div><input type="number" class="form-control atv-vagas" placeholder="Vagas"></div></div></div><div class="row g-1 mb-1"><div class="col-6"><input type="date" class="form-control form-control-sm atv-data"></div><div class="col-6"><input type="time" class="form-control form-control-sm atv-hora"></div></div><div class="row g-1 mb-1"><div class="col-6"><input type="text" class="form-control form-control-sm atv-local" placeholder="üìç Local"></div><div class="col-6"><input type="text" class="form-control form-control-sm atv-palestrante" placeholder="üé§ Palestrantes"></div></div><textarea class="form-control form-control-sm mb-1 atv-desc" placeholder="Descri√ß√£o" rows="1"></textarea><button type="button" class="btn btn-danger btn-sm w-100 py-0" onclick="this.parentElement.remove()">Remover</button>`;
        document.getElementById(containerId).appendChild(div);
    }
    function toggleAtvVagas(cb) { const input = cb.closest('.input-group').querySelector('.atv-vagas'); input.disabled = cb.checked; if(cb.checked) input.value = ''; }
    function coletarAtividades(containerId) {
        let lista = [];
        document.querySelectorAll(`#${containerId} .card`).forEach(el => {
            const isUnlim = el.querySelector('.atv-unlim').checked;
            lista.push({nome: el.querySelector('.atv-nome').value, horas: el.querySelector('.atv-horas').value, vagas: isUnlim ? -1 : el.querySelector('.atv-vagas').value, data_atv: el.querySelector('.atv-data').value, hora_atv: el.querySelector('.atv-hora').value, local: el.querySelector('.atv-local').value, palestrante: el.querySelector('.atv-palestrante').value, descricao: el.querySelector('.atv-desc').value});
        }); return lista;
    }
    document.getElementById('formEvento')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = { nome: document.getElementById('evNome').value, descricao: document.getElementById('evDesc').value, is_rapido: document.getElementById('checkRapido').checked, data_inicio: document.getElementById('evDataIni').value, hora_inicio: document.getElementById('evHoraIni').value, data_fim: document.getElementById('evDataFim').value, hora_fim: document.getElementById('evHoraFim').value, atividades: coletarAtividades('containerAtividades') };
        const res = await fetch('/api/criar_evento', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
        const json = await res.json();
        if(res.ok) { document.getElementById('formEvento').reset(); document.getElementById('containerAtividades').innerHTML = ''; carregarEventosGestor(); } else alert(json.erro);
    });

    // --- PROJETOR ---
    function abrirProjetor(idEvento) {
        const ev = CACHE_EVENTOS.find(e => e.id == idEvento); if(!ev) return;
        const select = document.getElementById('selectAtividadeProjetor');
        select.innerHTML = '<option value="" disabled selected>-- Escolha a Atividade --</option>';
        ev.atividades.forEach(a => select.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        atividadeAtualID = null; document.getElementById('qrContainer').classList.add('d-none'); document.getElementById('timerContainer').classList.add('d-none'); document.getElementById('msgSelect').classList.remove('d-none'); new bootstrap.Modal(document.getElementById('modalProjetor')).show();
        if (ev.atividades.length === 1) { select.selectedIndex = 1; mudarAtividadeProjetor(); }
    }
    function mudarAtividadeProjetor() {
        atividadeAtualID = document.getElementById('selectAtividadeProjetor').value;
        document.getElementById('msgSelect').classList.add('d-none'); document.getElementById('qrContainer').classList.remove('d-none'); document.getElementById('timerContainer').classList.remove('d-none');
        atualizarQR(true); if(intervaloQR) clearInterval(intervaloQR); intervaloQR = setInterval(() => atualizarQR(false), 1000);
    }
    function atualizarQR(force) {
        if(!atividadeAtualID) return; const restante = 30 - (new Date().getSeconds() % 30); document.getElementById('timerDisplay').innerText = `${restante}s`;
        if (force || restante === 30) { document.getElementById('imgQrDinamico').src = `/api/qrcode_atividade/${atividadeAtualID}?t=${new Date().getTime()}`; }
    }
    function fecharProjetor() { clearInterval(intervaloQR); bootstrap.Modal.getInstance(document.getElementById('modalProjetor')).hide(); }

    // --- LISTAGEM GESTOR ---
    async function carregarEventosGestor() {
        const res = await fetch('/api/eventos'); CACHE_EVENTOS = await res.json();
        const div = document.getElementById('listaEventosGestor'); div.innerHTML = '';
        CACHE_EVENTOS.forEach(ev => {
            div.innerHTML += `<div class="border-bottom py-3 d-flex justify-content-between align-items-center"><div><h6 class="m-0 fw-bold">${ev.nome}</h6><small class="text-muted">${ev.atividades.length} atividades</small></div><div><button onclick="abrirRelatorio(${ev.id})" class="btn btn-outline-primary btn-sm me-1"><i class="fa-solid fa-users"></i></button><button onclick="abrirModalEdicao(${ev.id})" class="btn btn-outline-warning btn-sm me-1"><i class="fa-solid fa-pen"></i></button><button onclick="abrirProjetor(${ev.id})" class="btn btn-dark btn-sm rounded-pill px-3"><i class="fa-solid fa-play"></i> Projetar</button></div></div>`;
        });
    }
    // Edi√ß√£o e Relat√≥rio
    function abrirModalEdicao(id) { const ev = CACHE_EVENTOS.find(e => e.id == id); if(!ev) return; document.getElementById('editEvId').value = ev.id; document.getElementById('editEvNome').value = ev.nome; document.getElementById('editEvDesc').value = ev.descricao; document.getElementById('editDataIni').value = ev.data_inicio; document.getElementById('editHoraIni').value = ev.hora_inicio; document.getElementById('editDataFim').value = ev.data_fim; document.getElementById('editHoraFim').value = ev.hora_fim; const container = document.getElementById('containerAtividadesEdit'); container.innerHTML = ''; ev.atividades.forEach(a => { addAtividade('containerAtividadesEdit'); const card = container.lastElementChild; card.querySelector('.atv-nome').value = a.nome; card.querySelector('.atv-horas').value = a.carga_horaria; const checkUnlim = card.querySelector('.atv-unlim'); const inputVagas = card.querySelector('.atv-vagas'); if (a.vagas == -1) { checkUnlim.checked = true; inputVagas.disabled = true; inputVagas.value = ''; } else { checkUnlim.checked = false; inputVagas.disabled = false; inputVagas.value = a.vagas; } card.querySelector('.atv-data').value = a.data_atv; card.querySelector('.atv-hora').value = a.hora_atv; card.querySelector('.atv-local').value = a.local; card.querySelector('.atv-palestrante').value = a.palestrante; card.querySelector('.atv-desc').value = a.descricao; }); new bootstrap.Modal(document.getElementById('modalEditarEvento')).show(); }
    async function salvarEdicaoEvento() { const data = { id: document.getElementById('editEvId').value, nome: document.getElementById('editEvNome').value, descricao: document.getElementById('editEvDesc').value, data_inicio: document.getElementById('editDataIni').value, hora_inicio: document.getElementById('editHoraIni').value, data_fim: document.getElementById('editDataFim').value, hora_fim: document.getElementById('editHoraFim').value, atividades: coletarAtividades('containerAtividadesEdit') }; const res = await fetch('/api/editar_evento', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}); if(res.ok) { bootstrap.Modal.getInstance(document.getElementById('modalEditarEvento')).hide(); carregarEventosGestor(); } else alert("Erro ao editar"); }
    async function abrirRelatorio(evtId) { new bootstrap.Modal(document.getElementById('modalRelatorio')).show(); const res = await fetch(`/api/relatorio_inscritos/${evtId}`); const dados = await res.json(); let html = ''; dados.forEach(d => { html += `<h6 class="bg-light p-2 border-bottom fw-bold text-primary mt-3">${d.atividade}</h6>`; if(d.inscritos.length === 0) html += '<p class="text-muted small ps-3">Nenhum inscrito.</p>'; else { html += '<table class="table table-sm table-hover"><thead><tr><th>Nome</th><th>CPF</th><th>Status</th></tr></thead><tbody>'; d.inscritos.forEach(i => { const status = i.presente ? '<span class="badge bg-success">Presente</span>' : '<span class="badge bg-secondary">Ausente</span>'; html += `<tr><td>${i.nome}</td><td>${i.cpf}</td><td>${status}</td></tr>`; }); html += '</tbody></table>'; } }); document.getElementById('corpoRelatorio').innerHTML = html; }

    // --- ALUNO ---
    async function carregarEventosAluno() {
        const res = await fetch('/api/eventos'); const eventos = await res.json(); const div = document.getElementById('listaEventosAluno'); div.innerHTML = '';
        eventos.forEach(ev => {
            let htmlAtividades = '';
            ev.atividades.forEach(a => {
                const btnClass = a.inscrito ? 'btn-danger' : 'btn-outline-primary'; const btnText = a.inscrito ? 'Desinscrever' : 'Inscrever'; const acao = a.inscrito ? 'sair' : 'inscrever';
                let vagasInfo = a.vagas == -1 ? '<span class="badge bg-success">‚àû</span>' : `<span class="badge ${a.vagas - a.total_inscritos > 0 ? 'bg-primary' : 'bg-danger'}">${a.vagas - a.total_inscritos} vagas</span>`;
                htmlAtividades += `<div class="atv-card ${a.inscrito ? 'subscribed' : ''} mb-2"><div class="d-flex justify-content-between align-items-center"><strong>${a.nome}</strong><div>${vagasInfo} <span class="badge bg-secondary">${a.carga_horaria}h</span></div></div><div class="small text-muted mb-2">${a.data_atv || ''} ${a.hora_atv || ''} | ${a.local || ''}</div><p class="small mb-2 text-muted">${a.descricao || 'Sem descri√ß√£o'}</p><button onclick="toggleInscricao(${a.id}, '${acao}')" class="btn btn-sm ${btnClass} w-100">${btnText}</button></div>`;
            }); 
            div.innerHTML += `<div class="col-md-6 mb-3"><div class="glass-panel p-3 h-100"><h5 class="fw-bold mb-1">${ev.nome}</h5><p class="text-muted small mb-3">${ev.descricao || ''}</p>${htmlAtividades}</div></div>`;
        });
    }
    async function toggleInscricao(atvId, acao) { const res = await fetch('/api/toggle_inscricao', {method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({activity_id: atvId, acao: acao})}); const json = await res.json(); if(res.ok) carregarEventosAluno(); else alert(json.erro || json.mensagem); }

    // --- ADMIN (Mantido) ---
    async function carregarUsuarios() { const res = await fetch('/api/listar_usuarios'); const users = await res.json(); const tbody = document.getElementById('listaUsuarios'); tbody.innerHTML = ''; users.forEach(u => tbody.innerHTML += `<tr><td>${u.username}</td><td>${u.nome}</td><td>${u.role}</td><td><button class="btn btn-sm btn-primary" onclick="abrirEditUser('${u.username}', '${u.nome}', '${u.cpf}', '${u.role}')"><i class="fa-solid fa-pen"></i></button></td></tr>`); }
    function abrirEditUser(u, n, c, r) { document.getElementById('editUsername').value = u; document.getElementById('editNome').value = n; document.getElementById('editCpf').value = c; document.getElementById('editRole').value = r; new bootstrap.Modal(document.getElementById('modalEditUser')).show(); }
    async function salvarEdicaoUsuario() { const data = {username_alvo: document.getElementById('editUsername').value, nome: document.getElementById('editNome').value, cpf: document.getElementById('editCpf').value, role: document.getElementById('editRole').value}; await fetch('/api/editar_usuario', {method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide(); carregarUsuarios(); }
    function toggleForm() { document.getElementById('camposCompletos').style.display = document.getElementById('checkRapido').checked ? 'none' : 'block'; }
</script>
{% endblock %}