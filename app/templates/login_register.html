{% extends 'base.html' %}

{% block head_styles %}
    <style>
        body { 
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            justify-content: center;
            align-items: center;
        }

        /* Adjust main to center content only on login page */
        main {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-custom { 
            width: 100%; 
            max-width: 420px; 
            border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.8); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.05); 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .nav-pills {
            background: #f1f5f9;
            padding: 4px;
            border-radius: 12px;
        }

        .nav-pills .nav-link { 
            color: #64748b; 
            font-weight: 500;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .nav-pills .nav-link:hover {
            color: #1e293b;
        }

        .nav-pills .nav-link.active { 
            background-color: white; 
            color: #044d84; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .form-floating > .form-control {
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        .form-floating > .form-control:focus {
            background: white;
            border-color: #044d84;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .logo-icon {
            font-size: 2.5rem;
            color: #044d84;
            margin-bottom: 0.5rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="card card-custom p-4 p-md-5 mx-3 animate__animated animate__zoomIn">
        <div class="text-center mb-4">
            <i class="fa-solid fa-graduation-cap logo-icon"></i>
            <h3 class="fw-bold text-dark m-0">UniEventos</h3>
            <p class="text-muted small">Gestão Acadêmica Simplificada</p>
        </div>
        
        <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login">Entrar</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register">Criar Conta</button>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- LOGIN FORM -->
            <div class="tab-pane fade show active" id="pills-login">
                <form onsubmit="fazerLogin(event)">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="loginUser" placeholder="Usuário" required>
                        <label>Usuário</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="loginPass" placeholder="Senha" required>
                        <label>Senha</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        Acessar Sistema <i class="fa-solid fa-arrow-right ms-2"></i>
                    </button>
                    <div class="text-center">
                        <a href="#" class="text-decoration-none small text-muted">Esqueceu a senha?</a>
                    </div>
                </form>
            </div>
            
            <!-- REGISTER FORM -->
            <div class="tab-pane fade" id="pills-register">
                <form onsubmit="fazerCadastro(event)">
                    <div class="form-floating mb-2">
                        <input type="text" class="form-control" id="regNome" placeholder="Nome Completo" required>
                        <label>Nome Completo</label>
                    </div>
                    <div class="form-floating mb-2">
                        <input type="email" class="form-control" id="regEmail" placeholder="Email" required>
                        <label>Email (Para notificações)</label>
                    </div>
                    <div class="form-floating mb-2">
                        <input type="text" class="form-control" id="regCpf" placeholder="CPF" required>
                        <label>CPF</label>
                    </div>
                    <div class="form-floating mb-2">
                        <input type="text" class="form-control" id="regUser" placeholder="Usuário" required>
                        <label>Usuário (Login)</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="regPass" placeholder="Senha" required>
                        <label>Senha</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        Criar Conta
                    </button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        async function fazerLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Autenticando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/login', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: document.getElementById('loginUser').value,
                        password: document.getElementById('loginPass').value
                    })
                });
                if(res.ok) {
                    Toast.fire({ icon: 'success', title: 'Bem-vindo de volta!' });
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const json = await res.json();
                    Swal.fire({
                        icon: 'error',
                        title: 'Falha na Autenticação',
                        text: json.message || "Usuário ou senha inválidos",
                        confirmButtonColor: '#4f46e5'
                    });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro de Conexão', text: 'Não foi possível conectar ao servidor.' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function fazerCadastro(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/registrar', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome: document.getElementById('regNome').value,
                        email: document.getElementById('regEmail').value,
                        cpf: document.getElementById('regCpf').value,
                        username: document.getElementById('regUser').value,
                        password: document.getElementById('regPass').value
                    })
                });
                const json = await res.json();
                
                if(res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Conta Criada!',
                        text: 'Sua conta foi criada com sucesso. Agora você pode entrar no sistema.',
                        confirmButtonColor: '#4f46e5'
                    }).then(() => {
                        document.getElementById('pills-login-tab').click();
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Atenção',
                        text: json.mensagem || json.erro,
                        confirmButtonColor: '#4f46e5'
                    });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro de Conexão', text: 'Não foi possível realizar o cadastro.' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
{% endblock %}
